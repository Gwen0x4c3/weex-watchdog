<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weex äº¤æ˜“å‘˜ç›‘æ§ç³»ç»Ÿ</title>
    <link href="https://unpkg.com/element-plus/dist/index.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .header { background: #409EFF; color: white; padding: 1rem; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card { margin-bottom: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { text-align: center; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #409EFF; }
        .stat-label { color: #666; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸš€ Weex äº¤æ˜“å‘˜ç›‘æ§ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§äº¤æ˜“å‘˜å¼€ä»“å¹³ä»“åŠ¨æ€</p>
        </div>

        <div class="container">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_traders || 0 }}</div>
                    <div class="stat-label">ç›‘æ§äº¤æ˜“å‘˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.active_orders || 0 }}</div>
                    <div class="stat-label">æ´»è·ƒè®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_orders || 0 }}</div>
                    <div class="stat-label">æ€»è®¢å•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.notifications_sent || 0 }}</div>
                    <div class="stat-label">å·²å‘é€šçŸ¥</div>
                </div>
            </div>

            <!-- äº¤æ˜“å‘˜ç®¡ç† -->
            <el-card class="card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>äº¤æ˜“å‘˜ç®¡ç†</span>
                        <el-button type="primary" @click="showAddTraderDialog = true">
                            æ·»åŠ äº¤æ˜“å‘˜
                        </el-button>
                    </div>
                </template>

                <el-table :data="traders" style="width: 100%">
                    <el-table-column prop="trader_user_id" label="äº¤æ˜“å‘˜ID" width="150"></el-table-column>
                    <el-table-column prop="trader_name" label="äº¤æ˜“å‘˜åç§°" width="120"></el-table-column>
                    <el-table-column prop="monitor_interval" label="ç›‘æ§é—´éš”(ç§’)" width="120"></el-table-column>
                    <el-table-column label="å½“å‰å¸¦å•æ•°" width="120">
                        <template #default="scope">
                            <el-button type="text" @click="showActiveOrders(scope.row)" :disabled="!scope.row.is_active">
                                {{ getActiveOrderCount(scope.row.trader_user_id) }}
                            </el-button>
                        </template>
                    </el-table-column>
                    <el-table-column prop="is_active" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                {{ scope.row.is_active ? 'æ´»è·ƒ' : 'æš‚åœ' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="180">
                        <template #default="scope">
                            {{ formatDate(scope.row.created_at) }}
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="200">
                        <template #default="scope">
                            <el-button size="small" @click="editTrader(scope.row)">ç¼–è¾‘</el-button>
                            <el-button 
                                size="small" 
                                :type="scope.row.is_active ? 'warning' : 'success'"
                                @click="toggleTrader(scope.row)">
                                {{ scope.row.is_active ? 'æš‚åœ' : 'å¯ç”¨' }}
                            </el-button>
                            <el-button size="small" type="danger" @click="deleteTrader(scope.row)">åˆ é™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <el-pagination
                    background
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="traderTotal"
                    :page-size="traderPageSize"
                    :current-page="traderPage"
                    @size-change="handleTraderSizeChange"
                    @current-change="handleTraderPageChange"
                    style="margin-top: 1rem;">
                </el-pagination>
            </el-card>

            <!-- è®¢å•å†å² -->
            <el-card class="card">
                <template #header>
                    <span>è®¢å•å†å²</span>
                </template>

                <el-table :data="orders" style="width: 100%">
                    <el-table-column prop="trader_name" label="äº¤æ˜“å‘˜" width="120"></el-table-column>
                    <el-table-column prop="contract_symbol" label="äº¤æ˜“å¯¹" width="120"></el-table-column>
                    <el-table-column prop="position_side" label="æ–¹å‘" width="80"></el-table-column>
                    <el-table-column prop="open_price" label="ä»·æ ¼" width="120"></el-table-column>
                    <el-table-column prop="open_leverage" label="æ æ†" width="80"></el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.status === 'ACTIVE' ? 'success' : 'info'">
                                {{ scope.row.status === 'ACTIVE' ? 'æ´»è·ƒ' : 'å·²å¹³ä»“' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="first_seen_at" label="å¼€ä»“æ—¶é—´" width="180">
                        <template #default="scope">
                            {{ formatDate(scope.row.first_seen_at) }}
                        </template>
                    </el-table-column>
                </el-table>

                <el-pagination
                    background
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="orderTotal"
                    :page-size="orderPageSize"
                    :current-page="orderPage"
                    @size-change="handleOrderSizeChange"
                    @current-change="handleOrderPageChange"
                    style="margin-top: 1rem;">
                </el-pagination>
            </el-card>
        </div>

        <!-- æ·»åŠ äº¤æ˜“å‘˜å¯¹è¯æ¡† -->
        <el-dialog v-model="showAddTraderDialog" title="æ·»åŠ äº¤æ˜“å‘˜" width="30%">
            <el-form :model="traderForm" label-width="120px">
                <el-form-item label="äº¤æ˜“å‘˜ID" required>
                    <el-input v-model="traderForm.trader_user_id" placeholder="è¯·è¾“å…¥äº¤æ˜“å‘˜ID"></el-input>
                </el-form-item>
                <el-form-item label="äº¤æ˜“å‘˜åç§°">
                    <el-input v-model="traderForm.trader_name" placeholder="è¯·è¾“å…¥äº¤æ˜“å‘˜åç§°"></el-input>
                </el-form-item>
                <el-form-item label="ç›‘æ§é—´éš”(ç§’)">
                    <el-input-number v-model="traderForm.monitor_interval" :min="10" :max="300" placeholder="30"></el-input-number>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showAddTraderDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveTrader">ä¿å­˜</el-button>
                </span>
            </template>
        </el-dialog>
<!-- æ´»è·ƒè®¢å•å¯¹è¯æ¡† -->
<el-dialog v-model="showActiveOrdersDialog"
    :title="`${selectedTrader?.trader_name || selectedTrader?.trader_user_id} çš„æ´»è·ƒè®¢å•`" width="80%">
    <el-table :data="activeOrders" style="width: 100%">
        <el-table-column prop="order_id" label="è®¢å•ID" width="150"></el-table-column>
        <el-table-column prop="contract_symbol" label="äº¤æ˜“å¯¹" width="120"></el-table-column>
        <el-table-column prop="position_side" label="æ–¹å‘" width="80">
            <template #default="scope">
                <el-tag :type="scope.row.position_side === 'LONG' ? 'success' : 'danger'">
                    {{ scope.row.position_side === 'LONG' ? 'å¤š' : 'ç©º' }}
                </el-tag>
            </template>
        </el-table-column>
        <el-table-column prop="open_price" label="å¼€ä»“ä»·æ ¼" width="120"></el-table-column>
        <el-table-column prop="open_leverage" label="æ æ†" width="80"></el-table-column>
        <el-table-column prop="first_seen_at" label="å¼€ä»“æ—¶é—´" width="180">
            <template #default="scope">
                {{ formatDate(scope.row.first_seen_at) }}
            </template>
        </el-table-column>
        <el-table-column label="æŒä»“æ—¶é•¿" width="120">
            <template #default="scope">
                {{ getDuration(scope.row.first_seen_at) }}
            </template>
        </el-table-column>
    </el-table>
    <div v-if="activeOrders.length === 0" style="text-align: center; padding: 2rem; color: #999;">
        æš‚æ— æ´»è·ƒè®¢å•
    </div>
</el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    stats: {},
                    traders: [],
                    orders: [],
                    activeOrders: [],
                    traderActiveOrderCounts: {}, // å­˜å‚¨æ¯ä¸ªäº¤æ˜“å‘˜çš„æ´»è·ƒè®¢å•æ•°
                    traderTotal: 0,
                    traderPage: 1,
                    traderPageSize: 10,
                    orderTotal: 0,
                    orderPage: 1,
                    orderPageSize: 20,
                    showAddTraderDialog: false,
                    showActiveOrdersDialog: false,
                    selectedTrader: null,
                    traderForm: {
                        trader_user_id: '',
                        trader_name: '',
                        monitor_interval: 30
                    },
                    editingTrader: null
                }
            },
            mounted() {
                this.loadStats();
                this.loadTraders();
                this.loadOrders();
                // å®šæ—¶åˆ·æ–°æ•°æ®
                setInterval(() => {
                    this.loadStats();
                    this.loadOrders();
                    this.loadTraderActiveOrderCounts();
                }, 30000);
            },
            methods: {
                async loadStats() {
                    try {
                        const response = await axios.get('/api/v1/orders/statistics');
                        this.stats = response.data.data;
                    } catch (error) {
                        console.error('Load stats failed:', error);
                    }
                },
                async loadTraders() {
                    try {
                        const response = await axios.get(`/api/v1/traders?page=${this.traderPage}&size=${this.traderPageSize}`);
                        this.traders = response.data.data;
                        this.traderTotal = response.data.total;
                        // åŠ è½½å®Œäº¤æ˜“å‘˜åï¼ŒåŠ è½½æ´»è·ƒè®¢å•æ•°
                        this.loadTraderActiveOrderCounts();
                    } catch (error) {
                        ElMessage.error('åŠ è½½äº¤æ˜“å‘˜åˆ—è¡¨å¤±è´¥');
                    }
                },
                async loadOrders() {
                    try {
                        const response = await axios.get(`/api/v1/orders?page=${this.orderPage}&size=${this.orderPageSize}`);
                        this.orders = response.data.data;
                        this.orderTotal = response.data.total;
                    } catch (error) {
                        ElMessage.error('åŠ è½½è®¢å•å†å²å¤±è´¥');
                    }
                },
                async loadTraderActiveOrderCounts() {
                    // ä¸ºæ¯ä¸ªäº¤æ˜“å‘˜åŠ è½½æ´»è·ƒè®¢å•æ•°
                    for (const trader of this.traders) {
                        try {
                            const response = await axios.get(`/api/v1/orders/active?trader_user_id=${trader.trader_user_id}`);
                            this.traderActiveOrderCounts[trader.trader_user_id] = response.data.data.length;
                        } catch (error) {
                            this.traderActiveOrderCounts[trader.trader_user_id] = 0;
                        }
                    }
                },
                async showActiveOrders(trader) {
                    this.selectedTrader = trader;
                    try {
                        const response = await axios.get(`/api/v1/orders/active?trader_user_id=${trader.trader_user_id}`);
                        this.activeOrders = response.data.data;
                        this.showActiveOrdersDialog = true;
                    } catch (error) {
                        ElMessage.error('åŠ è½½æ´»è·ƒè®¢å•å¤±è´¥');
                        this.activeOrders = [];
                        this.showActiveOrdersDialog = true;
                    }
                },
                getActiveOrderCount(traderUserID) {
                    return this.traderActiveOrderCounts[traderUserID] || 0;
                },
                getDuration(startTime) {
                    const start = new Date(startTime);
                    const now = new Date();
                    const diff = now - start;

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                    if (days > 0) {
                        return `${days}å¤©${hours}å°æ—¶`;
                    } else if (hours > 0) {
                        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                    } else {
                        return `${minutes}åˆ†é’Ÿ`;
                    }
                },
                async saveTrader() {
                    try {
                        if (this.editingTrader) {
                            await axios.put(`/api/v1/traders/${this.editingTrader.id}`, this.traderForm);
                            ElMessage.success('æ›´æ–°æˆåŠŸ');
                        } else {
                            await axios.post('/api/v1/traders', this.traderForm);
                            ElMessage.success('æ·»åŠ æˆåŠŸ');
                        }
                        this.showAddTraderDialog = false;
                        this.resetTraderForm();
                        this.loadTraders();
                    } catch (error) {
                        ElMessage.error(error.response?.data?.message || 'æ“ä½œå¤±è´¥');
                    }
                },
                editTrader(trader) {
                    this.editingTrader = trader;
                    this.traderForm = { ...trader };
                    this.showAddTraderDialog = true;
                },
                async toggleTrader(trader) {
                    try {
                        await axios.post(`/api/v1/traders/${trader.id}/toggle`, {
                            is_active: !trader.is_active
                        });
                        ElMessage.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
                        this.loadTraders();
                    } catch (error) {
                        ElMessage.error('çŠ¶æ€æ›´æ–°å¤±è´¥');
                    }
                },
                async deleteTrader(trader) {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº¤æ˜“å‘˜å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning',
                        });
                        await axios.delete(`/api/v1/traders/${trader.id}`);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        this.loadTraders();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                resetTraderForm() {
                    this.traderForm = {
                        trader_user_id: '',
                        trader_name: '',
                        monitor_interval: 30
                    };
                    this.editingTrader = null;
                },
                handleTraderSizeChange(size) {
                    this.traderPageSize = size;
                    this.loadTraders();
                },
                handleTraderPageChange(page) {
                    this.traderPage = page;
                    this.loadTraders();
                },
                handleOrderSizeChange(size) {
                    this.orderPageSize = size;
                    this.loadOrders();
                },
                handleOrderPageChange(page) {
                    this.orderPage = page;
                    this.loadOrders();
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleString('zh-CN');
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
