<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weex äº¤æ˜“å‘˜ç›‘æ§ç³»ç»Ÿ</title>
    <link href="https://unpkg.com/element-plus/dist/index.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .header { background: #409EFF; color: white; padding: 1rem; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card { margin-bottom: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { text-align: center; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #409EFF; }
        .stat-label { color: #666; margin-top: 0.5rem; }
        .price-panel { position: fixed; right: 20px; top: 20px; width: 320px; height: 500px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); z-index: 1000; }
        .price-header { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .price-content { height: 420px; overflow-y: auto; }
        .price-item { display: flex; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #f5f5f5; }
        .price-item:hover { background: #f9f9f9; }
        .price-symbol { font-weight: bold; }
        .price-value { font-family: monospace; }
        .price-up { color: #67c23a; }
        .price-down { color: #f56c6c; }
        .price-panel-toggle { position: fixed; right: 20px; top: 540px; z-index: 1001; }
        .order-filters { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .order-filters .el-form-item { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸš€ Weex äº¤æ˜“å‘˜ç›‘æ§ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§äº¤æ˜“å‘˜å¼€ä»“å¹³ä»“åŠ¨æ€</p>
        </div>

        <div class="container">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_traders || 0 }}</div>
                    <div class="stat-label">ç›‘æ§äº¤æ˜“å‘˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.active_orders || 0 }}</div>
                    <div class="stat-label">æŒä»“è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_orders || 0 }}</div>
                    <div class="stat-label">æ€»è®¢å•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.notifications_sent || 0 }}</div>
                    <div class="stat-label">å·²å‘é€šçŸ¥</div>
                </div>
            </div>

            <!-- äº¤æ˜“å‘˜ç®¡ç† -->
            <el-card class="card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>äº¤æ˜“å‘˜ç®¡ç†</span>
                        <el-button type="primary" @click="showAddTraderDialog = true">
                            æ·»åŠ äº¤æ˜“å‘˜
                        </el-button>
                    </div>
                </template>

                <el-table :data="traders" style="width: 100%">
                    <el-table-column prop="trader_user_id" label="äº¤æ˜“å‘˜ID"></el-table-column>
                    <el-table-column prop="trader_name" label="äº¤æ˜“å‘˜åç§°"></el-table-column>
                    <el-table-column prop="monitor_interval" label="ç›‘æ§é—´éš”(ç§’)" width="120"></el-table-column>
                    <el-table-column label="å½“å‰å¸¦å•æ•°" width="120">
                        <template #default="scope">
                            <el-button type="text" @click="showActiveOrders(scope.row)" :disabled="!scope.row.is_active">
                                {{ getActiveOrderCount(scope.row.trader_user_id) }}
                            </el-button>
                        </template>
                    </el-table-column>
                    <el-table-column prop="is_active" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
                                {{ scope.row.is_active ? 'æ´»è·ƒ' : 'æš‚åœ' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´">
                        <template #default="scope">
                            {{ formatDate(scope.row.created_at) }}
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ">
                        <template #default="scope">
                            <el-button size="small" @click="editTrader(scope.row)">ç¼–è¾‘</el-button>
                            <el-button 
                                size="small" 
                                :type="scope.row.is_active ? 'warning' : 'success'"
                                @click="toggleTrader(scope.row)">
                                {{ scope.row.is_active ? 'æš‚åœ' : 'å¯ç”¨' }}
                            </el-button>
                            <el-button size="small" type="danger" @click="deleteTrader(scope.row)">åˆ é™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <el-pagination
                    background
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="traderTotal"
                    :page-size="traderPageSize"
                    :current-page="traderPage"
                    @size-change="handleTraderSizeChange"
                    @current-change="handleTraderPageChange"
                    style="margin-top: 1rem;">
                </el-pagination>
            </el-card>

            <!-- è®¢å•å†å² -->
            <el-card class="card">
                <template #header>
                    <span>è®¢å•å†å²</span>
                </template>

                <!-- ç­›é€‰è¡¨å• -->
                <el-form :inline="true" :model="orderFilters" class="order-filters" style="margin-bottom: 20px;">
                    <el-form-item label="äº¤æ˜“å‘˜åç§°">
                        <el-input v-model="orderFilters.trader_name" placeholder="è¾“å…¥äº¤æ˜“å‘˜åç§°" @blur="loadOrdersWithFilters" clearable
                            style="width: 150px;">
                        </el-input>
                    </el-form-item>
                    <el-form-item label="å¸ç§">
                        <el-input v-model="orderFilters.contract_symbol" placeholder="è¾“å…¥å¸ç§ï¼Œå¦‚BTC" @blur="loadOrdersWithFilters" clearable
                            style="width: 150px;">
                        </el-input>
                    </el-form-item>
                    <el-form-item label="çŠ¶æ€">
                        <el-select v-model="orderFilters.status" placeholder="é€‰æ‹©çŠ¶æ€" @change="loadOrdersWithFilters" clearable
                            style="width: 120px;">
                            <el-option label="æŒä»“ä¸­" value="ACTIVE"></el-option>
                            <el-option label="å·²å¹³ä»“" value="CLOSED"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="å¼€ä»“æ—¶é—´">
                        <el-select v-model="orderFilters.date_filter" placeholder="é€‰æ‹©æ—¶é—´èŒƒå›´" @change="loadOrdersWithFilters" clearable
                            style="width: 120px;">
                            <el-option label="ä»Šæ—¥" value="today"></el-option>
                            <el-option label="æœ€è¿‘7å¤©" value="7days"></el-option>
                            <el-option label="æœ€è¿‘10å¤©" value="10days"></el-option>
                            <el-option label="æœ€è¿‘1ä¸ªæœˆ" value="30days"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="resetFilters">é‡ç½®</el-button>
                    </el-form-item>
                </el-form>

                <el-table :data="orders" style="width: 100%">
                    <el-table-column prop="trader_name" label="äº¤æ˜“å‘˜"></el-table-column>
                    <el-table-column prop="contract_symbol" label="äº¤æ˜“å¯¹"></el-table-column>
                    <el-table-column prop="position_side" label="æ–¹å‘" width="80"></el-table-column>
                    <el-table-column prop="open_price" label="ä»·æ ¼"></el-table-column>
                    <el-table-column prop="open_leverage" label="æ æ†"></el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.status === 'ACTIVE' ? 'success' : 'info'">
                                {{ scope.row.status === 'ACTIVE' ? 'æŒä»“ä¸­' : 'å·²å¹³ä»“' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="first_seen_at" label="å¼€ä»“æ—¶é—´">
                        <template #default="scope">
                            {{ formatDate(scope.row.first_seen_at) }}
                        </template>
                    </el-table-column>
                </el-table>

                <el-pagination
                    background
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="orderTotal"
                    :page-size="orderPageSize"
                    :current-page="orderPage"
                    @size-change="handleOrderSizeChange"
                    @current-change="handleOrderPageChange"
                    style="margin-top: 1rem;">
                </el-pagination>
            </el-card>
        </div>

        <!-- ä»·æ ¼é¢æ¿ -->
        <div v-show="showPricePanel" class="price-panel">
            <div class="price-header">
                <span>å¸‚åœºä»·æ ¼</span>
                <el-button size="small" @click="showPricePanel = false" type="text">Ã—</el-button>
            </div>
            <el-tabs v-model="activePriceTab" style="padding: 0 15px;">
                <el-tab-pane label="è‡ªé€‰" name="favorite">
                    <div style="margin-bottom: 10px;">
                        <el-button size="small" type="primary" @click="showAddSymbolDialog = true">æ‰‹åŠ¨æ·»åŠ </el-button>
                    </div>
                    <div class="price-content" style="height: 330px;">
                        <div v-for="ticker in favoriteTickers" :key="ticker.contractId" class="price-item">
                            <div>
                                <div class="price-symbol">{{ getSymbolName(ticker.contractId) }}</div>
                                <div style="font-size: 12px; color: #999;">{{ ticker.contractId }}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="price-value" :class="getPriceClass(ticker.priceChangePercent)">
                                    {{ formatPrice(ticker.lastPrice) }}
                                </div>
                                <div style="font-size: 12px;" :class="getPriceClass(ticker.priceChangePercent)">
                                    {{ ticker.priceChangePercent > 0 ? '+' : '' }}{{ (ticker.priceChangePercent *
                                    100).toFixed(2) }}%
                                </div>
                                <el-button size="small" type="text" @click="removeFavorite(ticker.contractId)">ç§»é™¤</el-button>
                            </div>
                        </div>
                        <div v-if="favoriteTickers.length === 0" style="text-align: center; padding: 2rem; color: #999;">
                            æš‚æ— è‡ªé€‰å¸ç§
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="å…¨éƒ¨" name="all">
                    <div class="price-content" style="height: 300px;">
                        <div v-for="ticker in allTickers" :key="ticker.contractId" class="price-item">
                            <div>
                                <div class="price-symbol">{{ getSymbolName(ticker.contractId) }}</div>
                                <div style="font-size: 12px; color: #999;">{{ ticker.contractId }}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="price-value" :class="getPriceClass(ticker.priceChangePercent)">
                                    {{ formatPrice(ticker.lastPrice) }}
                                </div>
                                <div style="font-size: 12px;" :class="getPriceClass(ticker.priceChangePercent)">
                                    {{ ticker.priceChangePercent > 0 ? '+' : '' }}{{ (ticker.priceChangePercent *
                                    100).toFixed(2) }}%
                                </div>
                                <el-button v-if="!favoriteContractIds.includes(ticker.contractId)" size="small" type="text"
                                    @click="addFavorite(ticker.contractId)">è‡ªé€‰</el-button>
                            </div>
                        </div>
                    </div>
                    <el-pagination background layout="prev, pager, next" :total="allTickersTotal"
                        :page-size="allTickersPageSize" :current-page="allTickersPage"
                        @current-change="handleAllTickersPageChange" style="margin-top: 10px; text-align: center;">
                    </el-pagination>
                </el-tab-pane>
            </el-tabs>
        </div>
        
        <!-- ä»·æ ¼é¢æ¿åˆ‡æ¢æŒ‰é’® -->
        <el-button class="price-panel-toggle" @click="showPricePanel = !showPricePanel" type="primary" circle>
            {{ showPricePanel ? 'Ã—' : '$' }}
        </el-button>

        <!-- æ·»åŠ äº¤æ˜“å‘˜å¯¹è¯æ¡† -->
        <el-dialog v-model="showAddTraderDialog" title="æ·»åŠ äº¤æ˜“å‘˜" width="30%">
            <el-form :model="traderForm" label-width="120px">
                <el-form-item label="äº¤æ˜“å‘˜ID" required>
                    <el-input v-model="traderForm.trader_user_id" placeholder="è¯·è¾“å…¥äº¤æ˜“å‘˜ID"></el-input>
                </el-form-item>
                <el-form-item label="äº¤æ˜“å‘˜åç§°">
                    <el-input v-model="traderForm.trader_name" placeholder="è¯·è¾“å…¥äº¤æ˜“å‘˜åç§°"></el-input>
                </el-form-item>
                <el-form-item label="ç›‘æ§é—´éš”(ç§’)">
                    <el-input-number v-model="traderForm.monitor_interval" :min="10" :max="300" placeholder="30"></el-input-number>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showAddTraderDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveTrader">ä¿å­˜</el-button>
                </span>
            </template>
        </el-dialog>
<!-- æ‰‹åŠ¨æ·»åŠ è‡ªé€‰å¯¹è¯æ¡† -->
<el-dialog v-model="showAddSymbolDialog" title="æ·»åŠ è‡ªé€‰å¸ç§" width="30%">
    <el-form label-width="80px">
        <el-form-item label="äº¤æ˜“å¯¹">
            <el-input v-model="newSymbolInput" placeholder="è¯·è¾“å…¥äº¤æ˜“å¯¹ï¼Œå¦‚ï¼šETH/USDT" @keyup.enter="addSymbolManually">
            </el-input>
        </el-form-item>
    </el-form>
    <template #footer>
        <span class="dialog-footer">
            <el-button @click="showAddSymbolDialog = false">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="addSymbolManually">æ·»åŠ </el-button>
        </span>
    </template>
</el-dialog>
<!-- æŒä»“ä¸­è®¢å•å¯¹è¯æ¡† -->
<el-dialog v-model="showActiveOrdersDialog"
    :title="`${selectedTrader?.trader_name || selectedTrader?.trader_user_id} çš„æŒä»“ä¸­è®¢å•`" width="70%">
    <el-table :data="activeOrders" style="width: 100%">
        <el-table-column prop="contract_symbol" label="äº¤æ˜“å¯¹"></el-table-column>
        <el-table-column prop="position_side" label="æ–¹å‘" width="80">
            <template #default="scope">
                <el-tag :type="scope.row.position_side === 'LONG' ? 'success' : 'danger'">
                    {{ scope.row.position_side === 'LONG' ? 'å¤š' : 'ç©º' }}
                </el-tag>
            </template>
        </el-table-column>
        <el-table-column prop="open_price" label="å¼€ä»“ä»·æ ¼"></el-table-column>
        <el-table-column label="å½“å‰ä»·æ ¼">
            <template #default="scope">
                <span :class="getPriceClass(getOrderPnlPercent(scope.row))">
                    {{ getCurrentPrice(scope.row.contract_symbol) }}
                </span>
            </template>
        </el-table-column>
        <el-table-column prop="open_leverage" label="æ æ†" width="80"></el-table-column>
        <el-table-column label="ç›ˆäºæ¯”ä¾‹">
            <template #default="scope">
                <span :class="getPriceClass(getOrderPnlPercent(scope.row))" style="font-weight: bold;">
                    {{ getOrderPnlPercent(scope.row) > 0 ? '+' : '' }}{{ getOrderPnlPercent(scope.row).toFixed(2) }}%
                </span>
            </template>
        </el-table-column>
        <el-table-column prop="first_seen_at" label="å¼€ä»“æ—¶é—´">
            <template #default="scope">
                {{ formatDate(scope.row.first_seen_at) }}
            </template>
        </el-table-column>
        <el-table-column label="æŒä»“æ—¶é•¿">
            <template #default="scope">
                {{ getDuration(scope.row.first_seen_at) }}
            </template>
        </el-table-column>
    </el-table>
    <div v-if="activeOrders.length === 0" style="text-align: center; padding: 2rem; color: #999;">
        æš‚æ— æŒä»“ä¸­è®¢å•
    </div>
</el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    stats: {},
                    traders: [],
                    orders: [],
                    activeOrders: [],
                    traderActiveOrderCounts: {}, // å­˜å‚¨æ¯ä¸ªäº¤æ˜“å‘˜çš„æŒä»“è®¢å•æ•°
                    traderTotal: 0,
                    traderPage: 1,
                    traderPageSize: 10,
                    orderTotal: 0,
                    orderPage: 1,
                    orderPageSize: 20,
                    // è®¢å•ç­›é€‰
                    orderFilters: {
                        trader_name: '',
                        contract_symbol: '',
                        status: '',
                        date_filter: ''
                    },
                    showAddTraderDialog: false,
                    showActiveOrdersDialog: false,
                    selectedTrader: null,
                    traderForm: {
                        trader_user_id: '',
                        trader_name: '',
                        monitor_interval: 30
                    },
                    editingTrader: null,
                    // ä»·æ ¼ç›¸å…³æ•°æ®
                    showPricePanel: true,
                    activePriceTab: 'favorite',
                    ws: null,
                    wsReconnectAttempts: 0,
                    maxReconnectAttempts: 5,
                    reconnectInterval: 5000,
                    pingInterval: null,
                    tickers: {}, // æ‰€æœ‰tickeræ•°æ®ï¼Œä»¥contractIdä¸ºkey
                    favoriteContractIds: [], // è‡ªé€‰å¸ç§IDåˆ—è¡¨
                    contractNames: {}, // åˆçº¦IDåˆ°åç§°çš„æ˜ å°„ï¼Œä»contracts.jsonåŠ è½½
                    // æ‰‹åŠ¨æ·»åŠ è‡ªé€‰ç›¸å…³
                    showAddSymbolDialog: false,
                    newSymbolInput: '',
                    // åˆ†é¡µç›¸å…³
                    allTickersPage: 1,
                    allTickersPageSize: 20
                }
            },
            mounted() {
                this.loadContractNames();
                this.loadStats();
                this.loadTraders();
                this.loadOrdersWithFilters();
                this.loadFavorites();
                this.initWebSocket();
                // å®šæ—¶åˆ·æ–°æ•°æ®
                setInterval(() => {
                    this.loadStats();
                    this.loadOrdersWithFilters();
                    this.loadTraderActiveOrderCounts();
                }, 30000);
            },
            computed: {
                allTickers() {
                    const sorted = Object.values(this.tickers).sort((a, b) => parseFloat(b.value) - parseFloat(a.value));
                    const startIndex = (this.allTickersPage - 1) * this.allTickersPageSize;
                    const endIndex = startIndex + this.allTickersPageSize;
                    return sorted.slice(startIndex, endIndex);
                },
                allTickersTotal() {
                    return Object.keys(this.tickers).length;
                },
                favoriteTickers() {
                    return this.favoriteContractIds.map(id => this.tickers[id]).filter(ticker => ticker);
                }
            },
            methods: {
                async loadStats() {
                    try {
                        const response = await axios.get('/api/v1/orders/statistics');
                        this.stats = response.data.data;
                    } catch (error) {
                        console.error('Load stats failed:', error);
                    }
                },
                // åŠ è½½åˆçº¦æ˜ å°„æ•°æ®
                async loadContractNames() {
                    try {
                        const response = await axios.get('/static/contracts.json');
                        this.contractNames = response.data;
                        console.log('Loaded contract names:', Object.keys(this.contractNames).length);
                    } catch (error) {
                        console.error('Failed to load contract names:', error);
                        ElMessage.error('åŠ è½½åˆçº¦æ•°æ®å¤±è´¥');
                    }
                },
                async loadTraders() {
                    try {
                        const response = await axios.get(`/api/v1/traders?page=${this.traderPage}&size=${this.traderPageSize}`);
                        this.traders = response.data.data;
                        this.traderTotal = response.data.total;
                        // åŠ è½½å®Œäº¤æ˜“å‘˜åï¼ŒåŠ è½½æŒä»“è®¢å•æ•°
                        this.loadTraderActiveOrderCounts();
                    } catch (error) {
                        ElMessage.error('åŠ è½½äº¤æ˜“å‘˜åˆ—è¡¨å¤±è´¥');
                    }
                },
                async loadOrders() {
                    try {
                        const response = await axios.get(`/api/v1/orders?page=${this.orderPage}&size=${this.orderPageSize}`);
                        this.orders = response.data.data;
                        this.orderTotal = response.data.total;
                    } catch (error) {
                        ElMessage.error('åŠ è½½è®¢å•å†å²å¤±è´¥');
                    }
                },
                async loadOrdersWithFilters() {
                    try {
                        const params = new URLSearchParams({
                            page: this.orderPage.toString(),
                            size: this.orderPageSize.toString()
                        });

                        // æ·»åŠ ç­›é€‰å‚æ•°
                        if (this.orderFilters.trader_name) {
                            params.append('trader_name', this.orderFilters.trader_name);
                        }
                        if (this.orderFilters.contract_symbol) {
                            params.append('contract_symbol', this.orderFilters.contract_symbol);
                        }
                        if (this.orderFilters.status) {
                            params.append('status', this.orderFilters.status);
                        }
                        if (this.orderFilters.date_filter) {
                            params.append('date_filter', this.orderFilters.date_filter);
                        }

                        const response = await axios.get(`/api/v1/orders?${params.toString()}`);
                        this.orders = response.data.data;
                        this.orderTotal = response.data.total;
                    } catch (error) {
                        ElMessage.error('åŠ è½½è®¢å•å†å²å¤±è´¥');
                    }
                },
                resetFilters() {
                    this.orderFilters = {
                        trader_name: '',
                        contract_symbol: '',
                        status: '',
                        date_filter: ''
                    };
                    this.orderPage = 1;
                    this.loadOrdersWithFilters();
                },
                async loadTraderActiveOrderCounts() {
                    // ä¸ºæ¯ä¸ªäº¤æ˜“å‘˜åŠ è½½æŒä»“è®¢å•æ•°
                    for (const trader of this.traders) {
                        try {
                            const response = await axios.get(`/api/v1/orders/active?trader_user_id=${trader.trader_user_id}`);
                            this.traderActiveOrderCounts[trader.trader_user_id] = response.data.data.length;
                        } catch (error) {
                            this.traderActiveOrderCounts[trader.trader_user_id] = 0;
                        }
                    }
                },
                async showActiveOrders(trader) {
                    this.selectedTrader = trader;
                    try {
                        const response = await axios.get(`/api/v1/orders/active?trader_user_id=${trader.trader_user_id}`);
                        this.activeOrders = response.data.data;
                        this.showActiveOrdersDialog = true;
                    } catch (error) {
                        ElMessage.error('åŠ è½½æŒä»“è®¢å•å¤±è´¥');
                        this.activeOrders = [];
                        this.showActiveOrdersDialog = true;
                    }
                },
                getActiveOrderCount(traderUserID) {
                    return this.traderActiveOrderCounts[traderUserID] || 0;
                },
                getDuration(startTime) {
                    const start = new Date(startTime);
                    const now = new Date();
                    const diff = now - start;

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                    if (days > 0) {
                        return `${days}å¤©${hours}å°æ—¶`;
                    } else if (hours > 0) {
                        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                    } else {
                        return `${minutes}åˆ†é’Ÿ`;
                    }
                },
                // WebSocketç›¸å…³æ–¹æ³•
                initWebSocket() {
                    this.connectWebSocket();
                },
                connectWebSocket() {
                    try {
                        this.ws = new WebSocket('wss://ws-gateway1.janapw.com/api/v1/public/ws?vs=z5z7Dug8SjhTlG9OFxy87dMe4a47K6Vu&compress=1&languageType=1');

                        this.ws.onopen = () => {
                            console.log('WebSocket connected');
                            this.wsReconnectAttempts = 0;
                            this.startPing();
                            this.subscribeToTicker();
                        };

                        this.ws.onmessage = (event) => {
                            this.handleWebSocketMessage(event);
                        };

                        this.ws.onclose = () => {
                            console.log('WebSocket disconnected');
                            this.stopPing();
                            this.handleReconnect();
                        };

                        this.ws.onerror = (error) => {
                            console.error('WebSocket error:', error);
                        };
                    } catch (error) {
                        console.error('Failed to connect WebSocket:', error);
                        this.handleReconnect();
                    }
                },
                handleWebSocketMessage(event) {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.event === 'ping') {
                            // å“åº”æœåŠ¡å™¨çš„ping
                            this.sendPong(message.time);
                        } else if (message.event === 'pong') {
                            // æœåŠ¡å™¨å¯¹æˆ‘ä»¬pingçš„å“åº”
                            console.log('Received pong from server');
                        } else if (message.event === 'payload' && message.channel === 'ticker.all.v2') {
                            // å¤„ç†ä»·æ ¼æ•°æ®
                            this.updateTickers(message.data);
                        }
                    } catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                },
                startPing() {
                    this.stopPing();
                    this.pingInterval = setInterval(() => {
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            const pingMessage = {
                                event: 'ping',
                                time: Date.now().toString()
                            };
                            this.ws.send(JSON.stringify(pingMessage));
                        }
                    }, 30000); // 30ç§’å‘é€ä¸€æ¬¡ping
                },
                stopPing() {
                    if (this.pingInterval) {
                        clearInterval(this.pingInterval);
                        this.pingInterval = null;
                    }
                },
                sendPong(time) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const pongMessage = {
                            event: 'pong',
                            time: time
                        };
                        this.ws.send(JSON.stringify(pongMessage));
                    }
                },
                subscribeToTicker() {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const subscribeMessage = {
                            event: 'subscribe',
                            channel: 'ticker.all.v2'
                        };
                        this.ws.send(JSON.stringify(subscribeMessage));
                        console.log('Subscribed to ticker.all.v2');
                    }
                },
                handleReconnect() {
                    if (this.wsReconnectAttempts < this.maxReconnectAttempts) {
                        this.wsReconnectAttempts++;
                        console.log(`Attempting to reconnect... (${this.wsReconnectAttempts}/${this.maxReconnectAttempts})`);
                        setTimeout(() => {
                            this.connectWebSocket();
                        }, this.reconnectInterval);
                    } else {
                        console.error('Max reconnection attempts reached');
                    }
                },
                updateTickers(tickerData) {
                    tickerData.forEach(ticker => {
                        this.tickers[ticker.contractId] = {
                            ...ticker,
                            priceChangePercent: parseFloat(ticker.priceChangePercent),
                            lastPrice: parseFloat(ticker.lastPrice),
                            markPrice: parseFloat(ticker.markPrice)
                        };
                    });
                },
                // ä»·æ ¼ç›¸å…³æ–¹æ³•
                getPriceClass(changePercent) {
                    if (changePercent > 0) return 'price-up';
                    if (changePercent < 0) return 'price-down';
                    return '';
                },
                formatPrice(price) {
                    if (!price) return '--';
                    return parseFloat(price).toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 6
                    });
                },
                getSymbolName(contractId) {
                    return this.contractNames[contractId] || `Contract ${contractId}`;
                },
                getCurrentPrice(contractSymbol) {
                    // æ ¹æ®åˆçº¦ç¬¦å·æŸ¥æ‰¾å¯¹åº”çš„ä»·æ ¼
                    const ticker = Object.values(this.tickers).find(t =>
                        this.getSymbolName(t.contractId) === contractSymbol
                    );
                    return ticker ? this.formatPrice(ticker.lastPrice) : '--';
                },
                getOrderPnlPercent(order) {
                    if (!order.contract_symbol || !order.open_price) return 0;

                    const ticker = Object.values(this.tickers).find(t =>
                        this.getSymbolName(t.contractId) === order.contract_symbol
                    );

                    if (!ticker) return 0;

                    const openPrice = parseFloat(order.open_price);
                    const currentPrice = ticker.lastPrice;
                    const leverage = parseFloat(order.open_leverage.replace('x', ''));

                    let pnlPercent = 0;
                    if (order.position_side === 'LONG') {
                        pnlPercent = ((currentPrice - openPrice) / openPrice) * 100 * leverage;
                    } else {
                        pnlPercent = ((openPrice - currentPrice) / openPrice) * 100 * leverage;
                    }

                    return pnlPercent;
                },
                // è‡ªé€‰ç®¡ç†æ–¹æ³•
                loadFavorites() {
                    const saved = localStorage.getItem('favorite_contracts');
                    if (saved) {
                        this.favoriteContractIds = JSON.parse(saved);
                    }
                },
                saveFavorites() {
                    localStorage.setItem('favorite_contracts', JSON.stringify(this.favoriteContractIds));
                },
                addFavorite(contractId) {
                    if (!this.favoriteContractIds.includes(contractId)) {
                        this.favoriteContractIds.push(contractId);
                        this.saveFavorites();
                        ElMessage.success('å·²æ·»åŠ åˆ°è‡ªé€‰');
                    }
                },
                removeFavorite(contractId) {
                    const index = this.favoriteContractIds.indexOf(contractId);
                    if (index > -1) {
                        this.favoriteContractIds.splice(index, 1);
                        this.saveFavorites();
                        ElMessage.success('å·²ä»è‡ªé€‰ç§»é™¤');
                    }
                },
                // æ‰‹åŠ¨æ·»åŠ è‡ªé€‰å¸ç§
                addSymbolManually() {
                    const symbol = this.newSymbolInput.trim().toUpperCase();
                    if (!symbol) {
                        ElMessage.error('è¯·è¾“å…¥äº¤æ˜“å¯¹');
                        return;
                    }

                    // æŸ¥æ‰¾å¯¹åº”çš„contractId
                    const contractId = Object.keys(this.contractNames).find(id =>
                        this.contractNames[id] === symbol
                    );

                    if (!contractId) {
                        ElMessage.error(`æœªæ‰¾åˆ°äº¤æ˜“å¯¹ ${symbol}ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®`);
                        return;
                    }

                    if (this.favoriteContractIds.includes(contractId)) {
                        ElMessage.warning('è¯¥å¸ç§å·²åœ¨è‡ªé€‰åˆ—è¡¨ä¸­');
                        return;
                    }

                    this.favoriteContractIds.push(contractId);
                    this.saveFavorites();
                    this.showAddSymbolDialog = false;
                    this.newSymbolInput = '';
                    ElMessage.success(`å·²æ·»åŠ  ${symbol} åˆ°è‡ªé€‰`);
                },
                // å¤„ç†å…¨éƒ¨å¸ç§åˆ†é¡µ
                handleAllTickersPageChange(page) {
                    this.allTickersPage = page;
                },
                async saveTrader() {
                    try {
                        if (this.editingTrader) {
                            await axios.put(`/api/v1/traders/${this.editingTrader.id}`, this.traderForm);
                            ElMessage.success('æ›´æ–°æˆåŠŸ');
                        } else {
                            await axios.post('/api/v1/traders', this.traderForm);
                            ElMessage.success('æ·»åŠ æˆåŠŸ');
                        }
                        this.showAddTraderDialog = false;
                        this.resetTraderForm();
                        this.loadTraders();
                    } catch (error) {
                        ElMessage.error(error.response?.data?.message || 'æ“ä½œå¤±è´¥');
                    }
                },
                editTrader(trader) {
                    this.editingTrader = trader;
                    this.traderForm = { ...trader };
                    this.showAddTraderDialog = true;
                },
                async toggleTrader(trader) {
                    try {
                        await axios.post(`/api/v1/traders/${trader.id}/toggle`, {
                            is_active: !trader.is_active
                        });
                        ElMessage.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
                        this.loadTraders();
                    } catch (error) {
                        ElMessage.error('çŠ¶æ€æ›´æ–°å¤±è´¥');
                    }
                },
                async deleteTrader(trader) {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº¤æ˜“å‘˜å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning',
                        });
                        await axios.delete(`/api/v1/traders/${trader.id}`);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        this.loadTraders();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                resetTraderForm() {
                    this.traderForm = {
                        trader_user_id: '',
                        trader_name: '',
                        monitor_interval: 30
                    };
                    this.editingTrader = null;
                },
                handleTraderSizeChange(size) {
                    this.traderPageSize = size;
                    this.loadTraders();
                },
                handleTraderPageChange(page) {
                    this.traderPage = page;
                    this.loadTraders();
                },
                handleOrderSizeChange(size) {
                    this.orderPageSize = size;
                    this.loadOrdersWithFilters();
                },
                handleOrderPageChange(page) {
                    this.orderPage = page;
                    this.loadOrdersWithFilters();
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleString('zh-CN');
                }
            },
            beforeUnmount() {
                // æ¸…ç†WebSocketè¿æ¥
                this.stopPing();
                if (this.ws) {
                    this.ws.close();
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
