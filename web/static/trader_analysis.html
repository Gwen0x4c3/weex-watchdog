<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“å‘˜åˆ†ææŠ¥å‘Š</title>
    <link href="https://unpkg.com/element-plus/dist/index.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        .header { 
            background: #409EFF; 
            color: white; 
            padding: 1rem; 
            text-align: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem; 
        }
        .analysis-header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1rem; 
            margin-bottom: 2rem; 
        }
        .metric-card { 
            background: white;
            text-align: center; 
            padding: 1.5rem; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-value { 
            font-size: 1.8rem; 
            font-weight: bold; 
            margin-bottom: 0.5rem;
        }
        .metric-label { 
            color: #666; 
            font-size: 0.9rem;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .chart-container {
            width: 100%;
            height: 300px;
        }
        .profit { color: #67c23a; }
        .loss { color: #f56c6c; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ“Š äº¤æ˜“å‘˜åˆ†ææŠ¥å‘Š</h1>
            <p>æ·±åº¦åˆ†æäº¤æ˜“å‘˜å†å²è¡¨ç°ï¼Œç§‘å­¦è¯„ä¼°æŠ•èµ„ä»·å€¼</p>
        </div>

        <div class="container">
            <!-- åˆ†æå‚æ•°è®¾ç½® -->
            <div class="analysis-header">
                <el-form :inline="true" :model="analysisParams" @submit.prevent="analyzeTrader">
                    <el-form-item label="äº¤æ˜“å‘˜ID">
                        <el-input v-model="analysisParams.traderId" placeholder="è¾“å…¥äº¤æ˜“å‘˜ID" style="width: 150px;"></el-input>
                    </el-form-item>
                    <el-form-item label="åˆ†ææ—¶é—´èŒƒå›´">
                        <el-select v-model="analysisParams.timeRange" style="width: 120px;">
                            <el-option label="æœ€è¿‘7å¤©" value="7d"></el-option>
                            <el-option label="æœ€è¿‘30å¤©" value="30d"></el-option>
                            <el-option label="æœ€è¿‘90å¤©" value="90d"></el-option>
                            <el-option label="æœ€è¿‘1å¹´" value="1y"></el-option>
                            <el-option label="å…¨éƒ¨" value="all"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="åˆå§‹èµ„é‡‘(U)">
                        <el-input-number v-model="analysisParams.initialCapital" :min="0" :step="100" style="width: 150px;"></el-input-number>
                    </el-form-item>
                    <el-form-item label="å•æ¬¡è·ŸæŠ•(U)">
                        <el-input-number v-model="analysisParams.investPerOrder" :min="0" :step="10" style="width: 150px;"></el-input-number>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="analyzeTrader" :loading="loading">å¼€å§‹åˆ†æ</el-button>
                    </el-form-item>
                </el-form>
            </div>

            <!-- åŠ è½½é®ç½© -->
            <div v-if="loading" class="loading-overlay">
                <el-loading-spinner size="large"></el-loading-spinner>
            </div>

            <!-- åˆ†æç»“æœ -->
            <div v-if="analysisResult">
                <!-- åŸºç¡€æŒ‡æ ‡ -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">{{ analysisResult.total_orders }}</div>
                        <div class="metric-label">æ€»è®¢å•æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" :class="analysisResult.win_rate >= 50 ? 'profit' : 'loss'">
                            {{ analysisResult.win_rate.toFixed(2) }}%
                        </div>
                        <div class="metric-label">èƒœç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" :class="analysisResult.total_pnl >= 0 ? 'profit' : 'loss'">
                            {{ analysisResult.total_pnl.toFixed(2) }}U
                        </div>
                        <div class="metric-label">æ€»ç›ˆäº</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" :class="analysisResult.profit_loss_ratio >= 1 ? 'profit' : 'loss'">
                            {{ analysisResult.profit_loss_ratio.toFixed(2) }}
                        </div>
                        <div class="metric-label">ç›ˆäºæ¯”</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ analysisResult.avg_holding_hours.toFixed(1) }}h</div>
                        <div class="metric-label">å¹³å‡æŒä»“(h)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ analysisResult.holding_time_p25.toFixed(1) }}h</div>
                        <div class="metric-label">æŒä»“P25(h)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ analysisResult.holding_time_p50.toFixed(1) }}h</div>
                        <div class="metric-label">æŒä»“ä¸­ä½æ•°(h)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ analysisResult.holding_time_p75.toFixed(1) }}h</div>
                        <div class="metric-label">æŒä»“P75(h)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ analysisResult.max_holding_hours.toFixed(1) }}h</div>
                        <div class="metric-label">æœ€é•¿æŒä»“(h)</div>
                    </div>
                </div>

                <!-- è·ŸæŠ•æ”¶ç›Š -->
                <div v-if="analysisResult.follow_profit" class="metric-card" style="margin-bottom: 2rem;">
                    <h3>ğŸ’° è·ŸæŠ•æ”¶ç›Šæ¨¡æ‹Ÿ</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">{{ analysisResult.follow_profit.orders_followed }}</div>
                            <div class="metric-label">è·ŸæŠ•è®¢å•æ•°</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">{{ analysisResult.follow_profit.initial_capital.toFixed(2) }}U</div>
                            <div class="metric-label">åˆå§‹èµ„é‡‘</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">{{ analysisResult.follow_profit.final_capital.toFixed(2) }}U</div>
                            <div class="metric-label">æœ€ç»ˆèµ„é‡‘</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" :class="analysisResult.follow_profit.total_profit >= 0 ? 'profit' : 'loss'">
                                {{ analysisResult.follow_profit.total_profit.toFixed(2) }}U
                            </div>
                            <div class="metric-label">æ€»æ”¶ç›Š</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" :class="analysisResult.follow_profit.profit_rate >= 0 ? 'profit' : 'loss'">
                                {{ analysisResult.follow_profit.profit_rate.toFixed(2) }}%
                            </div>
                            <div class="metric-label">æ”¶ç›Šç‡</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value loss">
                                {{ analysisResult.follow_profit.max_drawdown.toFixed(2) }}%
                            </div>
                            <div class="metric-label">æœ€å¤§å›æ’¤</div>
                        </div>
                    </div>
                </div>

                <!-- èµ„é‡‘æ›²çº¿ -->
                <div v-if="analysisResult.follow_profit && analysisResult.follow_profit.capital_curve" class="chart-card" style="grid-column: 1 / -1; margin-bottom: 2rem;">
                    <div class="chart-title">è·ŸæŠ•èµ„é‡‘æ›²çº¿</div>
                    <div id="capitalCurveChart" style="width: 100%; height: 400px;"></div>
                </div>

                <!-- å›¾è¡¨å±•ç¤º -->
                <div class="chart-grid">
                    <!-- å¸ç§é¢‘ç‡é¥¼å›¾ -->
                    <div class="chart-card">
                        <div class="chart-title">å¸ç§äº¤æ˜“é¢‘ç‡</div>
                        <div id="coinFrequencyChart" class="chart-container"></div>
                    </div>

                    <!-- å¸ç§èƒœç‡æŸ±çŠ¶å›¾ -->
                    <div class="chart-card">
                        <div class="chart-title">å„å¸ç§èƒœç‡</div>
                        <div id="coinWinRateChart" class="chart-container"></div>
                    </div>

                    <!-- å¸ç§ç›ˆäºåˆ†æ -->
                    <div class="chart-card">
                        <div class="chart-title">å„å¸ç§ç›ˆäº</div>
                        <div id="coinPnlChart" class="chart-container"></div>
                    </div>

                    <!-- æ æ†ä½¿ç”¨ç»Ÿè®¡ -->
                    <div class="chart-card">
                        <div class="chart-title">æ æ†ä½¿ç”¨ç»Ÿè®¡</div>
                        <div id="leverageChart" class="chart-container"></div>
                    </div>

                    <!-- æŒä»“æ—¶é—´åˆ†å¸ƒ -->
                    <div class="chart-card">
                        <div class="chart-title">æŒä»“æ—¶é—´åˆ†å¸ƒ</div>
                        <div id="holdingTimeChart" class="chart-container"></div>
                    </div>

                    <!-- äº¤æ˜“æ—¶é—´åˆ†å¸ƒ -->
                    <div class="chart-card">
                        <div class="chart-title">äº¤æ˜“æ—¶é—´åˆ†å¸ƒï¼ˆå°æ—¶ï¼‰</div>
                        <div id="hourlyChart" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- æ— æ•°æ®æç¤º -->
            <div v-else-if="!loading" style="text-align: center; padding: 3rem; color: #999;">
                <el-icon size="60"><Document /></el-icon>
                <p style="margin-top: 1rem;">è¯·è¾“å…¥äº¤æ˜“å‘˜IDå¹¶ç‚¹å‡»åˆ†ææŒ‰é’®å¼€å§‹åˆ†æ</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        // 1. Axios Interceptors for Auth
        // Request interceptor to add token to headers
        axios.interceptors.request.use(config => {
            const token = localStorage.getItem('authToken');
            if (token) {
                config.headers.Token = token;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        // Response interceptor to handle 401 Unauthorized
        axios.interceptors.response.use(response => {
            return response;
        }, error => {
            if (error.response && error.response.status === 401) {
                ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                localStorage.removeItem('authToken');
                // Redirect to login page after a short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            }
            return Promise.reject(error);
        });

        createApp({
            data() {
                return {
                    loading: false,
                    analysisParams: {
                        traderId: '',
                        timeRange: '30d',
                        initialCapital: 1000,
                        investPerOrder: 100
                    },
                    analysisResult: null,
                    charts: {}
                }
            },
            methods: {
                async analyzeTrader() {
                    if (!this.analysisParams.traderId) {
                        ElMessage.error('è¯·è¾“å…¥äº¤æ˜“å‘˜ID');
                        return;
                    }

                    this.loading = true;
                    try {
                        const params = new URLSearchParams({
                            time_range: this.analysisParams.timeRange,
                            initial_capital: this.analysisParams.initialCapital.toString(),
                            invest_per_order: this.analysisParams.investPerOrder.toString()
                        });

                        const response = await axios.get(`/api/v1/traders/${this.analysisParams.traderId}/analysis?${params.toString()}`);
                        
                        if (response.data.success) {
                            this.analysisResult = response.data.data;
                            this.$nextTick(() => {
                                this.renderCharts();
                            });
                            ElMessage.success('åˆ†æå®Œæˆ');
                        } else {
                            ElMessage.error(response.data.message || 'åˆ†æå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('Analysis error:', error);
                        ElMessage.error('åˆ†æå¤±è´¥ï¼š' + (error.response?.data?.message || error.message));
                    } finally {
                        this.loading = false;
                    }
                },

                renderCharts() {
                    this.renderCapitalCurveChart();
                    this.renderCoinFrequencyChart();
                    this.renderCoinWinRateChart();
                    this.renderCoinPnlChart();
                    this.renderLeverageChart();
                    this.renderHoldingTimeChart();
                    this.renderHourlyChart();
                },

                renderCoinFrequencyChart() {
                    const chart = echarts.init(document.getElementById('coinFrequencyChart'));
                    const data = Object.entries(this.analysisResult.coin_frequency)
                        .map(([coin, count]) => ({ name: coin, value: count }))
                        .sort((a, b) => b.value - a.value)
                        .slice(0, 10);

                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c} ({d}%)'
                        },
                        series: [{
                            name: 'äº¤æ˜“æ¬¡æ•°',
                            type: 'pie',
                            radius: '70%',
                            data: data,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.coinFrequency = chart;
                },

                renderCoinWinRateChart() {
                    const chart = echarts.init(document.getElementById('coinWinRateChart'));
                    const coins = Object.keys(this.analysisResult.coin_win_rate).slice(0, 10);
                    const winRates = coins.map(coin => this.analysisResult.coin_win_rate[coin].toFixed(2));

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        xAxis: {
                            type: 'category',
                            data: coins,
                            axisLabel: { rotate: 45 }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'èƒœç‡(%)'
                        },
                        series: [{
                            data: winRates,
                            type: 'bar',
                            itemStyle: {
                                color: function(params) {
                                    return params.value >= 50 ? '#67c23a' : '#f56c6c';
                                }
                            }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.coinWinRate = chart;
                },

                renderCoinPnlChart() {
                    const chart = echarts.init(document.getElementById('coinPnlChart'));
                    const coins = Object.keys(this.analysisResult.coin_pnl).slice(0, 10);
                    const pnls = coins.map(coin => this.analysisResult.coin_pnl[coin].toFixed(2));

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        xAxis: {
                            type: 'category',
                            data: coins,
                            axisLabel: { rotate: 45 }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ç›ˆäº(U)'
                        },
                        series: [{
                            data: pnls,
                            type: 'bar',
                            itemStyle: {
                                color: function(params) {
                                    return params.value >= 0 ? '#67c23a' : '#f56c6c';
                                }
                            }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.coinPnl = chart;
                },

                renderLeverageChart() {
                    const chart = echarts.init(document.getElementById('leverageChart'));
                    const data = Object.entries(this.analysisResult.leverage_stats)
                        .map(([leverage, count]) => ({ name: leverage, value: count }))
                        .sort((a, b) => parseInt(a.name) - parseInt(b.name));

                    const option = {
                        tooltip: {
                            trigger: 'item'
                        },
                        xAxis: {
                            type: 'category',
                            data: data.map(item => item.name)
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ä½¿ç”¨æ¬¡æ•°'
                        },
                        series: [{
                            data: data.map(item => item.value),
                            type: 'bar',
                            itemStyle: { color: '#409EFF' }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.leverage = chart;
                },

                renderHoldingTimeChart() {
                    const chart = echarts.init(document.getElementById('holdingTimeChart'));
                    const data = this.analysisResult.holding_time_distribution;

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        xAxis: {
                            type: 'category',
                            data: data.map(item => item.range)
                        },
                        yAxis: {
                            type: 'value',
                            name: 'æ¯”ä¾‹(%)'
                        },
                        series: [{
                            data: data.map(item => item.rate.toFixed(2)),
                            type: 'bar',
                            itemStyle: { color: '#E6A23C' }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.holdingTime = chart;
                },

                renderHourlyChart() {
                    const chart = echarts.init(document.getElementById('hourlyChart'));
                    const hours = Array.from({ length: 24 }, (_, i) => i);
                    const data = hours.map(hour => this.analysisResult.hourly_stats[hour] || 0);

                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: hours.map(h => h + ':00')
                        },
                        yAxis: {
                            type: 'value',
                            name: 'äº¤æ˜“æ¬¡æ•°'
                        },
                        series: [{
                            data: data,
                            type: 'line',
                            smooth: true,
                            itemStyle: { color: '#67c23a' },
                            areaStyle: { opacity: 0.3 }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.hourly = chart;
                },

                renderCapitalCurveChart() {
                    const chart = echarts.init(document.getElementById('capitalCurveChart'));
                    const data = this.analysisResult.follow_profit.capital_curve;
                    const initialCapital = this.analysisResult.follow_profit.initial_capital;

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            },
                            formatter: function (params) {
                                const point = params[0];
                                const time = new Date(point.axisValue).toLocaleString();
                                const capital = parseFloat(point.value[1]).toFixed(2);
                                const profitRate = ((capital - initialCapital) / initialCapital * 100).toFixed(2);
                                return `${time}<br/>èµ„é‡‘: <strong>${capital}U</strong><br/>æ”¶ç›Šç‡: <strong>${profitRate}%</strong>`;
                            }
                        },
                        xAxis: {
                            type: 'time',
                        },
                        yAxis: {
                            type: 'value',
                            name: 'æ€»èµ„é‡‘ (U)',
                            scale: true,
                            axisLabel: { formatter: '{value} U' }
                        },
                        dataZoom: [{
                            type: 'inside',
                            start: 0,
                            end: 100
                        }, {
                            type: 'slider', // ä¿®å¤ï¼šæ˜ç¡®æŒ‡å®šç±»å‹ä¸º slider
                            start: 0,
                            end: 100
                        }],
                        series: [{
                            name: 'èµ„é‡‘æ›²çº¿',
                            type: 'line',
                            smooth: true,
                            showSymbol: false,
                            data: data.map(p => [p.time, p.capital]), // ä¿®å¤ï¼šä¼ é€’åŸå§‹æ•°å­—è€Œéå­—ç¬¦ä¸²
                            itemStyle: { color: '#409EFF' },
                            markLine: {
                                silent: true,
                                data: [{
                                    yAxis: initialCapital,
                                    label: { formatter: 'åˆå§‹æœ¬é‡‘' }
                                }],
                                lineStyle: { type: 'dashed', color: '#999' }
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: 'rgba(64, 158, 255, 0.3)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(64, 158, 255, 0)'
                                }])
                            }
                        }]
                    };
                    chart.setOption(option);
                    this.charts.capitalCurve = chart;
                }
            },

            mounted() {
                // ä»URLå‚æ•°è·å–äº¤æ˜“å‘˜IDå’Œåç§°
                const urlParams = new URLSearchParams(window.location.search);
                const traderId = urlParams.get('trader_id');
                const traderName = urlParams.get('trader_name');
                
                if (traderId) {
                    this.analysisParams.traderId = traderId;
                    // å¦‚æœæœ‰äº¤æ˜“å‘˜åç§°ï¼Œæ›´æ–°é¡µé¢æ ‡é¢˜
                    if (traderName) {
                        document.title = `${decodeURIComponent(traderName)} - äº¤æ˜“å‘˜åˆ†ææŠ¥å‘Š`;
                        // å¯ä»¥é€‰æ‹©æ›´æ–°é¡µé¢å¤´éƒ¨æ˜¾ç¤º
                        const headerElement = document.querySelector('.header h1');
                        if (headerElement) {
                            headerElement.innerHTML = `ğŸ“Š ${decodeURIComponent(traderName)} - äº¤æ˜“å‘˜åˆ†ææŠ¥å‘Š`;
                        }
                    }
                    // è‡ªåŠ¨å¼€å§‹åˆ†æ
                    this.analyzeTrader();
                }

                // å“åº”å¼å›¾è¡¨
                window.addEventListener('resize', () => {
                    Object.values(this.charts).forEach(chart => {
                        chart.resize();
                    });
                });
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
